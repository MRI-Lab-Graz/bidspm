# High-Performance Octave BIDSPM Container
# Author: Karl Koschutnig, MRI Lab Graz
# Performance-optimized with existing Ubuntu Octave

FROM ubuntu:22.04

LABEL maintainer="Karl Koschutnig <karl.koschutnig@uni-graz.at>"
LABEL description="Performance-optimized BIDSPM container with enhanced Octave"
LABEL version="2025.1-performance"

# Environment for optimal performance
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC
ENV OCTAVE_EXECUTABLE=/usr/bin/octave
ENV BLAS_NUM_THREADS=4
ENV OPENBLAS_NUM_THREADS=4
ENV OMP_NUM_THREADS=4
ENV MKL_NUM_THREADS=4
ENV OMP_THREAD_LIMIT=4

# Install Octave and performance libraries (using default Ubuntu packages)
RUN apt-get update -qq && \
    apt-get -qq -y --no-install-recommends install \
        ca-certificates curl wget git unzip \
        python3 python3-pip python3-venv \
        octave octave-common octave-dev \
        octave-io octave-image octave-signal \
        octave-statistics octave-struct \
        octave-parallel octave-control octave-symbolic \
        liboctave-dev octave-pkg-dev \
        build-essential patch vim nano \
        libblas3 liblapack3 \
        libopenblas-base libopenblas-dev \
        libatlas-base-dev libeigen3-dev \
        gfortran g++ \
        libfftw3-dev \
        libhdf5-dev \
        libpcre3-dev && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Install UV for ultra-fast Python package management
RUN curl -LsSf https://astral.sh/uv/install.sh | sh && \
    mv /root/.local/bin/uv /usr/local/bin/uv && \
    chmod +x /usr/local/bin/uv

# Install Python packages with UV (fastest method)
RUN uv pip install --system --no-cache-dir \
        numpy scipy matplotlib pandas \
        nibabel nilearn bids-validator pybids \
        jsonschema setuptools wheel

# Download and compile SPM12 with maximum optimization
RUN mkdir -p /opt/spm12 && \
    echo "üì• Downloading SPM12 r7771..." && \
    curl -fsSL https://github.com/spm/spm12/archive/r7771.tar.gz | tar -xzC /opt/spm12 --strip-components=1 && \
    echo "üîß Applying Octave compatibility patches..." && \
    curl -fsSL https://raw.githubusercontent.com/spm/spm-octave/main/spm12_r7771.patch | patch -p0 && \
    echo "‚ö° Compiling SPM12 with $(nproc) CPU cores..." && \
    make -C /opt/spm12/src PLATFORM=octave distclean && \
    make -C /opt/spm12/src PLATFORM=octave -j$(nproc) CFLAGS="-O3 -ffast-math -march=native" CXXFLAGS="-O3 -ffast-math -march=native" && \
    make -C /opt/spm12/src PLATFORM=octave install && \
    echo "‚úÖ SPM12 r7771 compiled with aggressive optimizations"

# Create user with optimal configuration
RUN useradd -m -u 1000 -s /bin/bash neuro && \
    mkdir -p /home/neuro && \
    chown -R neuro:neuro /home/neuro && \
    chown -R neuro:neuro /opt/spm12

# Install BIDSPM 4.0 with full submodules
RUN echo "üì¶ Installing BIDSPM 4.0..." && \
    git clone --depth 1 --branch v4.0.0 https://github.com/cpp-lln-lab/bidspm.git /home/neuro/bidspm || \
    git clone --depth 1 https://github.com/cpp-lln-lab/bidspm.git /home/neuro/bidspm && \
    cd /home/neuro/bidspm && \
    git submodule update --init --recursive || true && \
    echo "‚úÖ BIDSPM 4.0 with submodules installed"

# Install BIDSPM Python CLI for proper entrypoint
RUN cd /home/neuro/bidspm && \
    pip install --no-cache-dir --break-system-packages . && \
    echo "‚úÖ BIDSPM Python CLI installed"

# Create optimized Octave performance configuration
RUN echo "% High-Performance Octave Configuration for BIDSPM" > /usr/share/octave/site/m/startup/octaverc && \
    echo "% Enable parallel processing" >> /usr/share/octave/site/m/startup/octaverc && \
    echo "try pkg load parallel; catch; end" >> /usr/share/octave/site/m/startup/octaverc && \
    echo "try pkg load struct; catch; end" >> /usr/share/octave/site/m/startup/octaverc && \
    echo "try pkg load io; catch; end" >> /usr/share/octave/site/m/startup/octaverc && \
    echo "try pkg load statistics; catch; end" >> /usr/share/octave/site/m/startup/octaverc && \
    echo "% Set performance options" >> /usr/share/octave/site/m/startup/octaverc && \
    echo "more off;" >> /usr/share/octave/site/m/startup/octaverc && \
    echo "clear -f;" >> /usr/share/octave/site/m/startup/octaverc && \
    echo "% Add SPM12 and BIDSPM paths" >> /usr/share/octave/site/m/startup/octaverc && \
    echo "addpath('/opt/spm12/');" >> /usr/share/octave/site/m/startup/octaverc && \
    echo "addpath('/home/neuro/bidspm');" >> /usr/share/octave/site/m/startup/octaverc && \
    echo "% Configure BLAS for performance" >> /usr/share/octave/site/m/startup/octaverc && \
    echo "setenv('OPENBLAS_NUM_THREADS', '4');" >> /usr/share/octave/site/m/startup/octaverc && \
    echo "setenv('BLAS_NUM_THREADS', '4');" >> /usr/share/octave/site/m/startup/octaverc && \
    echo "% End performance configuration" >> /usr/share/octave/site/m/startup/octaverc

# Fix all permissions
RUN chown -R neuro:neuro /home/neuro

# Switch to user for final tests
USER neuro
WORKDIR /home/neuro

# Performance validation
RUN echo "üß™ Testing optimized Octave..." && \
    octave --version && \
    octave --no-gui --eval "version; disp(['Octave version: ' version]); disp('‚úÖ Performance-optimized Octave ready!');" && \
    octave --no-gui --eval "addpath('/opt/spm12'); try; spm('defaults', 'fmri'); disp('‚úÖ SPM12 performance-optimized!'); catch e; disp(['‚ö†Ô∏è SPM12 issue: ' e.message]); end" && \
    echo "‚úÖ Performance validation completed"

# Use BIDSPM CLI entrypoint
ENTRYPOINT ["bidspm"]
CMD ["--help"]
